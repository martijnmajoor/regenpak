<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cycling Route with Weather and Wind</title>
</head>
<body>
  <h1>Cycling Route with Weather and Wind</h1>
  <div>
    <label for="addressFrom">From: </label>
    <input type="text" id="addressFrom" placeholder="Enter start address">
    <label for="addressTo">To: </label>
    <input type="text" id="addressTo" placeholder="Enter destination address">
    <label for="departureDateTime">Departure Time: </label>
    <input type="datetime-local" id="departureDateTime">
    <label for="speed">Speed (km/h): </label>
    <input type="number" id="speed" value="15">
    <button id="calculateBtn">Calculate Route</button>
  </div>

  <div id="weatherDisplay"></div>

  <script>
    document.getElementById("calculateBtn").addEventListener("click", async () => {
      const addressFrom = document.getElementById("addressFrom").value.trim();
      const addressTo = document.getElementById("addressTo").value.trim();
      const departureDateTime = document.getElementById("departureDateTime").value;
      const speed = parseFloat(document.getElementById("speed").value);

      if (!addressFrom || !addressTo || !departureDateTime) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        // Fetch route and marker data with weather
        const routeRes = await fetch(
          `/api/route?start=${encodeURIComponent(addressFrom)}&end=${encodeURIComponent(addressTo)}&speed=${speed}&departureTime=${encodeURIComponent(departureDateTime)}`
        );
        const routeData = await routeRes.json();
        const markers = routeData.markers;

        // Display weather and arrival time for each marker
        const weatherDisplay = document.getElementById("weatherDisplay");
        weatherDisplay.innerHTML = "<h3>Weather and Wind at Selected Points</h3>";

        markers.forEach((marker, index) => {
          const { lat, lng, weather, arrivalTime, wind } = marker;

          // Calculate expected arrival time as a readable format
          const arrivalTimeFormatted = new Date(arrivalTime * 1000).toLocaleString();

          // Determine if it's raining or not
          const isRaining = weather.description.toLowerCase().includes("rain");

          // Check for headwind or tailwind (simplified check based on wind direction and cycling direction)
          const windDirection = wind ? wind.deg : 0;  // Wind direction in degrees (0-360)
          const routeDirection = calculateRouteDirection(marker.lat, marker.lng); // To be implemented

          let windStatus = "No wind data available";
          if (windDirection) {
            windStatus = (Math.abs(windDirection - routeDirection) < 45) ? "Headwind" : "Tailwind"; // Simple check, 45 degrees tolerance
          }

          const weatherInfo = `
            <p>Marker ${index + 1} (Lat: ${lat}, Lng: ${lng}): 
              ${isRaining ? "It's raining" : "It's not raining"} at arrival time (${arrivalTimeFormatted}), 
              ${windStatus}</p>
          `;
          weatherDisplay.innerHTML += weatherInfo;
        });
      } catch (err) {
        console.error("Error fetching route or weather data:", err);
      }
    });

    // Placeholder function to calculate route direction. 
    // In practice, you'd need to calculate the direction of the route between two markers.
    function calculateRouteDirection(lat, lng) {
      // Example: this is a very simplified placeholder function.
      // Ideally, you would calculate the bearing between two points and then determine the route direction.
      // This will require more advanced geospatial calculations which can be done using libraries.
      return 90; // Placeholder, assumes a flat eastward route
    }
  </script>
</body>
</html>
