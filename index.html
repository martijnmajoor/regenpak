<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cycling Route Weather</title>
  </head>
  <body>
    <h1>Cycling Route Weather</h1>
    <form id="route-form">
      <label for="from">Address From:</label>
      <input type="text" id="from" name="from" required /><br />

      <label for="to">Address To:</label>
      <input type="text" id="to" name="to" required /><br />

      <label for="departure-time">Departure Time:</label>
      <input
        type="datetime-local"
        id="departure-time"
        name="departure-time"
        required
      /><br />

      <label for="speed">Cycling Speed:</label>
      <select id="speed" name="speed">
        <option value="leisurely">Leisurely (&lt;20 km/h)</option>
        <option value="active">Active (20-25 km/h)</option>
        <option value="racing">Racing/Electric (&gt;25 km/h)</option></select
      ><br />

      <label for="google-api-key">Google Maps API Key:</label>
      <input
        type="text"
        id="google-api-key"
        name="google-api-key"
        required
      /><br />

      <label for="openweather-api-key">OpenWeather API Key:</label>
      <input
        type="text"
        id="openweather-api-key"
        name="openweather-api-key"
        required
      /><br />

      <button type="submit">Get Route</button>
    </form>

    <h2>Route Details:</h2>
    <div id="route-output"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Load saved values from localStorage
        document.getElementById("from").value =
          localStorage.getItem("from") || "";
        document.getElementById("to").value = localStorage.getItem("to") || "";
        document.getElementById("speed").value =
          localStorage.getItem("cycling-speed") || "leisurely";

        // Set default departure time to current timestamp
        const now = new Date();
        document.getElementById("departure-time").value = now
          .toISOString()
          .slice(0, 16);
      });

      document
        .getElementById("route-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Get values from form
          const googleApiKey = document.getElementById("google-api-key").value;
          const openWeatherApiKey = document.getElementById(
            "openweather-api-key",
          ).value;

          const from = document.getElementById("from").value;
          const to = document.getElementById("to").value;
          const departureTime = new Date(
            document.getElementById("departure-time").value,
          );
          const speed = document.getElementById("speed").value;

          // Save values to localStorage
          localStorage.setItem("from", from);
          localStorage.setItem("to", to);
          localStorage.setItem("cycling-speed", speed);

          const route = await getRoute(from, to, googleApiKey);
          const weatherData = await getWeatherForRoute(
            route,
            departureTime,
            speed,
            openWeatherApiKey,
          );

          displayRouteDetails(route, weatherData);
        });

      async function getRoute(from, to, googleApiKey) {
        const directionsUrl = `https://maps.googleapis.com/maps/api/directions/json?origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&key=${googleApiKey}`;

        const response = await fetch(directionsUrl);
        const data = await response.json();

        if (data.status !== "OK") {
          alert("Error fetching route data");
          return [];
        }

        return data.routes[0].legs[0].steps; // Get step-by-step directions
      }

      async function getWeatherForRoute(
        route,
        departureTime,
        speed,
        openWeatherApiKey,
      ) {
        const weatherData = [];
        const weatherCheckInterval = 5 * 60 * 1000; // 5 minutes in milliseconds
        let travelTime = 0;

        const speedValues = {
          leisurely: 20 / 3.6,
          active: 25 / 3.6,
          racing: 30 / 3.6,
        };
        const selectedSpeed = speedValues[speed] || 20 / 3.6;

        for (let i = 0; i < route.length - 1; i++) {
          const step = route[i];
          const nextStep = route[i + 1];
          const stepDistance = step.distance.value;
          const stepTime = (stepDistance / selectedSpeed) * 1000;

          travelTime += stepTime;

          if (travelTime >= weatherCheckInterval) {
            const arrivalTime = new Date(departureTime.getTime() + travelTime);

            const { weather, windDeg } = await getWeatherForLocation(
              step.end_location,
              arrivalTime,
              openWeatherApiKey,
            );
            const cyclingDirection = calculateDirection(
              step.end_location,
              nextStep.end_location,
            );
            const windEffect = determineWindEffect(windDeg, cyclingDirection);

            weatherData.push({ step, weather, windEffect, arrivalTime });
            travelTime = 0;
          }
        }

        return weatherData;
      }

      async function getWeatherForLocation(
        location,
        arrivalTime,
        openWeatherApiKey,
      ) {
        const timestamp = Math.floor(arrivalTime.getTime() / 1000);
        const weatherUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${location.lat}&lon=${location.lng}&dt=${timestamp}&appid=${openWeatherApiKey}`;

        const response = await fetch(weatherUrl);
        const data = await response.json();

        return {
          weather: data.current.weather[0].description,
          windDeg: data.current.wind_deg,
        };
      }

      // Calculate bearing (direction) between two points
      function calculateDirection(start, end) {
        const lat1 = (Math.PI / 180) * start.lat;
        const lat2 = (Math.PI / 180) * end.lat;
        const deltaLng = (Math.PI / 180) * (end.lng - start.lng);

        const y = Math.sin(deltaLng) * Math.cos(lat2);
        const x =
          Math.cos(lat1) * Math.sin(lat2) -
          Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLng);

        return ((Math.atan2(y, x) * 180) / Math.PI + 360) % 360; // Normalize to 0-360°
      }

      // Determine wind impact based on direction
      function determineWindEffect(windDeg, cyclingDirection) {
        const angleDiff = Math.abs(windDeg - cyclingDirection);

        if (angleDiff <= 30 || angleDiff >= 330) {
          return "Tailwind ✅";
        } else if (angleDiff >= 150 && angleDiff <= 210) {
          return "Headwind 🆘";
        } else {
          return "Crosswind 🌬️";
        }
      }

      // Display the updated data
      function displayRouteDetails(route, weatherData) {
        const outputDiv = document.getElementById("route-output");
        outputDiv.innerHTML = "";

        weatherData.forEach(({ step, weather, windEffect, arrivalTime }) => {
          const marker = document.createElement("div");
          marker.innerHTML = `
            <p><strong>Step:</strong> ${step.html_instructions}</p>
            <p><strong>Distance:</strong> ${step.distance.text}</p>
            <p><strong>Arrival Time:</strong> ${arrivalTime.toLocaleTimeString()}</p>
            <p><strong>Weather at Arrival:</strong> ${weather}</p>
            <p><strong>Wind Effect:</strong> ${windEffect}</p>
        `;
          outputDiv.appendChild(marker);
        });
      }
    </script>
  </body>
</html>
